#! /usr/bin/env node
// @ts-check
const { fork } = require('child_process');
const { join } = require('path');

const { program } = require('commander');
const { editor } = require('@inquirer/prompts');

const entries = require("../../common/entries");

program
  .command("add")
  .description("adds a new entry to your brain")
  .argument("<title>", "title of the new entry")
  .option("-t, --tags [tags]", "adds extra tags to the new entry (csv)")
  .action(async (title, options) => {
    // TODO: Check if title already exists
    const tags = options.tags?.split(",") ?? [];
    const content = await editor({
      message: `Content for entry: ${title}`,
      postfix: ".md",
    });

    const data = { title, content, tags }
    const entryAbsolutePath = entries.addEntry(data)

    console.log(entryAbsolutePath)
    const worker = fork(join(__dirname, "..", "worker", "add-git-entry.js"), {
      detached: false,
      stdio: ['ignore', 'pipe', 'pipe', 'ipc'],
    });

    // Forward worker's stdout/stderr to parent's stdout/stderr
    worker.stdout.pipe(process.stdout);
    worker.stderr.pipe(process.stderr);

    worker.send(JSON.stringify([entryAbsolutePath, data]));

    // Handle worker exit
    worker.on('exit', (code) => {
      if (code !== 0) {
        console.error(`Worker process exited with code ${code}`);
      }
    });

  })
  .addHelpText('after', `
Example usage:
  $ brain add -t ts,array "How to filter an array in typescript"`
  );

program
  .command("edit")
  .description("edit an existing entry in your brain")
  .argument("<index>", "index of the entry to edit")
  .action(async (index) => {
    console.log(index)
  })
  .addHelpText('after', `
Example usage:
  $ brain edit 1`
  );

program
  .command("search")
  .description("search the brain for entries")
  .argument("<query...>", "search words to query your brain with")
  .action(async (query) => {
    console.log(query)
  })
  .addHelpText('after', `
Example usage:
  $ brain search ts array filter`
  );

program.parse();
